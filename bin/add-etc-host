#!/usr/bin/env ruby

hostname = ARGV[0]
hostip = ARGV[1]

if hostname.nil? or hostip.nil?
  $stderr.puts "Usage: #{$0} <hostname> <hostip>"
  $stderr.puts ""
  $stderr.puts " Add or modify an /etc/hosts entry for <hostname> to point to <hostip>."
  $stderr.puts " Must be run sudo."
  exit 1
end

unless File.writable?("/etc/hosts")
  $stderr.puts "#{$0} must be run sudo."
  exit 1
end

lines = File.readlines("/etc/hosts", encoding: "utf-8")
pattern = /^ *(?:[0-9]+\.){3}[0-9]+ +#{hostname}/
entry = "#{hostip} #{hostname}"
found = false

modified = lines.map do |line|
  if line =~ pattern
    found = true
    entry
  else
    line
  end
end

modified << entry unless found

File.write("/etc/hosts", modified.join, encoding: "utf-8")
